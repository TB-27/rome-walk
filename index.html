<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Rome Walking Tour - Feb 15</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.85.1/dist/L.Control.Locate.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
:root {
  --bg: #0f1118;
  --card: #181c28;
  --card-alt: #1e2233;
  --border: #252a3a;
  --accent: #e8564a;
  --accent-soft: rgba(232,86,74,0.15);
  --blue: #4a9eff;
  --green: #5cd47a;
  --yellow: #f5c842;
  --orange: #f5a623;
  --text: #eceef4;
  --text2: #a0a5b8;
  --text3: #6b7088;
  --optional: #6b7394;
  --radius: 14px;
  --font: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', system-ui, sans-serif;
}
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
html, body { height:100%; overflow:hidden; font-family:var(--font); background:var(--bg); color:var(--text); }

.app { display:flex; flex-direction:column; height:100%; height:100dvh; }

/* === MAP === */
#map { flex:0 0 48%; min-height:220px; z-index:1; }

/* Leaflet overrides */
.leaflet-div-icon { background:transparent; border:none; }
.mpin {
  width:36px; height:36px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-weight:800; font-size:15px; color:#fff;
  border:3px solid #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.4), 0 0 0 1px rgba(0,0,0,0.1);
  font-family:var(--font);
  transition: transform 0.2s;
}
.mpin.main { background:var(--accent); }
.mpin.opt  { background:var(--optional); }
.mpin.active { transform:scale(1.3); box-shadow: 0 0 0 4px var(--accent-soft), 0 2px 8px rgba(0,0,0,0.4); }

/* Popups */
.tp .leaflet-popup-content-wrapper {
  border-radius:var(--radius); padding:0; box-shadow:0 8px 30px rgba(0,0,0,0.3);
  background:#fff; overflow:hidden;
}
.tp .leaflet-popup-content { margin:0; font-family:var(--font); }
.tp .leaflet-popup-tip { box-shadow:0 4px 12px rgba(0,0,0,0.1); }
.pc { padding:14px 16px; }
.pc-top { display:flex; align-items:center; gap:10px; margin-bottom:6px; }
.pc-n { background:var(--accent); color:#fff; width:24px; height:24px; border-radius:50%;
  display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:800; flex-shrink:0; }
.pc-name { font-size:16px; font-weight:700; color:#1a1a2e; }
.pc-meta { font-size:13px; color:#888; margin-bottom:8px; }
.pc-note { font-size:14px; color:#444; margin-bottom:12px; line-height:1.45; }
.pc-nav { display:flex; gap:10px; padding-top:10px; border-top:1px solid #eee; }
.pc-nav a {
  flex:1; text-align:center; padding:10px 0; border-radius:8px;
  font-size:13px; font-weight:700; text-decoration:none;
  min-height:44px; display:flex; align-items:center; justify-content:center; gap:6px;
}
.pc-nav .apple { background:#000; color:#fff; }
.pc-nav .google { background:#4285f4; color:#fff; }

/* === BOTTOM PANEL === */
.panel {
  flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch;
  background:var(--bg);
}

/* Weather bar */
.wx {
  display:flex; align-items:center; gap:12px;
  padding:12px 20px;
  background: linear-gradient(135deg, #1a2540, #1e2848);
  border-bottom:1px solid var(--border);
  font-size:13px; color:var(--text2);
  position:sticky; top:0; z-index:5;
  backdrop-filter: blur(10px);
}
.wx-icon { font-size:22px; }
.wx-temp { font-size:17px; font-weight:700; color:var(--text); }
.wx-detail { display:flex; gap:12px; flex-wrap:wrap; }

/* Section header */
.shdr {
  padding:14px 20px 8px; font-size:11px; font-weight:700;
  text-transform:uppercase; letter-spacing:0.12em; color:var(--text3);
  position:sticky; top:50px; z-index:4; background:var(--bg);
}

/* Stop cards */
.stop {
  display:flex; gap:14px; padding:14px 20px;
  border-bottom:1px solid var(--border);
  cursor:pointer; transition:background 0.15s;
  position:relative;
}
.stop:active { background:var(--card-alt); }
.stop.active { background:var(--card); }
.stop.active::before {
  content:''; position:absolute; left:0; top:0; bottom:0; width:3px;
  background:var(--accent); border-radius:0 3px 3px 0;
}
.stop.opt .sname { color:var(--optional); }

/* Timeline connector */
.stop-left { display:flex; flex-direction:column; align-items:center; gap:4px; }
.snum {
  width:32px; height:32px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-weight:800; font-size:14px; color:#fff; flex-shrink:0;
}
.snum.main { background:var(--accent); }
.snum.opt  { background:var(--optional); }
.sline { width:2px; flex:1; min-height:16px; background:var(--border); border-radius:1px; }

.sinfo { flex:1; min-width:0; }
.sname { font-size:15px; font-weight:700; color:var(--text); margin-bottom:3px; }
.smeta { font-size:13px; color:var(--text3); display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
.smeta .tm { color:var(--blue); font-weight:700; }
.smeta .cost { color:var(--green); font-weight:600; }
.snote { font-size:13px; color:var(--text2); margin-top:5px; line-height:1.4; }

/* Badges */
.badge {
  font-size:11px; font-weight:700; padding:2px 8px; border-radius:6px;
  text-transform:uppercase; letter-spacing:0.04em;
}
.badge-booked { background:rgba(92,212,122,0.15); color:var(--green); border:1px solid rgba(92,212,122,0.3); }
.badge-lunch  { background:rgba(245,166,35,0.15); color:var(--orange); border:1px solid rgba(245,166,35,0.3); }
.badge-opt    { background:rgba(107,115,148,0.12); color:var(--optional); border:1px solid rgba(107,115,148,0.25); }
.badge-end    { background:rgba(74,158,255,0.12); color:var(--blue); border:1px solid rgba(74,158,255,0.25); }

/* Navigate buttons row */
.nav-row {
  display:flex; gap:8px; margin-top:8px;
}
.nav-btn {
  flex:1; padding:8px 0; border-radius:8px; font-size:12px; font-weight:700;
  text-decoration:none; text-align:center; min-height:36px;
  display:flex; align-items:center; justify-content:center; gap:4px;
}
.nav-btn.apple { background:#000; color:#fff; }
.nav-btn.google { background:#4285f4; color:#fff; }

/* Tips section */
.tips { padding:16px 20px; }
.tip-card {
  display:flex; gap:12px; padding:12px 14px; margin-bottom:8px;
  background:var(--card); border-radius:10px; border:1px solid var(--border);
  align-items:flex-start;
}
.tip-icon { font-size:18px; flex-shrink:0; margin-top:1px; }
.tip-label { font-size:13px; font-weight:700; margin-bottom:2px; }
.tip-text { font-size:13px; color:var(--text2); line-height:1.4; }

/* Week overview */
.week { padding:0 20px 8px; }
.week-hdr {
  padding:14px 0 10px; font-size:11px; font-weight:700;
  text-transform:uppercase; letter-spacing:0.12em; color:var(--text3);
  border-bottom:1px solid var(--border); margin-bottom:0;
}
.day {
  display:flex; gap:14px; padding:14px 0;
  border-bottom:1px solid var(--border);
  align-items:flex-start;
}
.day-date {
  min-width:52px; flex-shrink:0;
}
.day-dow { font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:0.06em; }
.day-num { font-size:20px; font-weight:800; color:var(--text); }
.day-today .day-num { color:var(--accent); }
.day-today .day-dow { color:var(--accent); }
.day-info { flex:1; min-width:0; }
.day-events { display:flex; flex-direction:column; gap:6px; }
.day-event {
  display:flex; align-items:center; gap:8px;
  padding:8px 12px; border-radius:8px;
  background:var(--card); border:1px solid var(--border);
  font-size:13px;
}
.day-event .ev-time { color:var(--blue); font-weight:700; min-width:44px; }
.day-event .ev-name { color:var(--text); font-weight:600; }
.day-event .ev-note { color:var(--text2); margin-left:4px; }
.day-event.ev-booked { border-color:rgba(92,212,122,0.3); }
.day-event.ev-booked .ev-badge { color:var(--green); font-size:11px; font-weight:700; margin-left:auto; }
.day-open { font-size:13px; color:var(--text3); font-style:italic; padding:4px 0; }

/* Footer */
.footer {
  padding:12px 20px 24px; text-align:center;
  font-size:12px; color:var(--text3); border-top:1px solid var(--border);
}

/* Expand/collapse for stop details */
.stop-expand { display:none; }
.stop.expanded .stop-expand { display:block; }

/* Tabs */
.tabs {
  display:flex; gap:6px; padding:10px 20px 6px;
  position:sticky; top:50px; z-index:5; background:var(--bg);
}
.tab {
  flex:1; padding:10px 0; border-radius:10px; text-align:center;
  font-size:13px; font-weight:700; cursor:pointer;
  border:1px solid var(--border); color:var(--text3);
  background:transparent; transition:all 0.2s;
  font-family:var(--font);
}
.tab.active { background:var(--accent); color:#fff; border-color:var(--accent); }
.tab:not(.active):active { background:var(--card-alt); }

/* Restaurant map pins */
.rpin {
  width:28px; height:28px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:13px; color:#fff; background:#d4a029;
  border:2px solid #fff;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  font-family:var(--font); font-weight:700;
}
.rpin.michelin { background:#c4362e; }
.rpin.active { transform:scale(1.3); box-shadow: 0 0 0 4px rgba(212,160,41,0.3), 0 2px 6px rgba(0,0,0,0.3); }

/* Restaurant list */
.rest-group-hdr {
  padding:14px 20px 6px; font-size:11px; font-weight:700;
  text-transform:uppercase; letter-spacing:0.1em; color:var(--text3);
}
.rest {
  display:flex; gap:12px; padding:12px 20px;
  border-bottom:1px solid var(--border);
  cursor:pointer; transition:background 0.15s;
  position:relative;
}
.rest:active { background:var(--card-alt); }
.rest.active { background:var(--card); }
.rest.active::before {
  content:''; position:absolute; left:0; top:0; bottom:0; width:3px;
  background:#d4a029; border-radius:0 3px 3px 0;
}
.rest .rnum {
  width:28px; height:28px; border-radius:50%; flex-shrink:0;
  display:flex; align-items:center; justify-content:center;
  font-size:12px; font-weight:700; color:#fff; background:#d4a029;
  margin-top:2px;
}
.rest .rnum.michelin { background:#c4362e; }
.rest .rinfo { flex:1; min-width:0; }
.rest .rname { font-size:15px; font-weight:700; color:var(--text); display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.rest .raddr { font-size:12px; color:var(--text3); margin-top:2px; }
.rest .rnote { font-size:13px; color:var(--text2); margin-top:4px; line-height:1.4; }
.rest .rlinks { display:flex; gap:8px; margin-top:6px; flex-wrap:wrap; }
.rest .rlinks a {
  font-size:12px; color:var(--blue); text-decoration:none; font-weight:600;
  padding:4px 10px; border-radius:6px; background:rgba(74,158,255,0.08);
  border:1px solid rgba(74,158,255,0.15);
}
.rest .rlinks a:active { opacity:0.6; }
.rest .rest-expand { display:none; }
.rest.expanded .rest-expand { display:block; }
.badge-michelin { background:rgba(196,54,46,0.15); color:#e85b52; border:1px solid rgba(196,54,46,0.3); }
.badge-seafood { background:rgba(74,158,255,0.12); color:var(--blue); border:1px solid rgba(74,158,255,0.25); }
.badge-wine { background:rgba(160,100,200,0.12); color:#b580d4; border:1px solid rgba(160,100,200,0.25); }
.badge-roman { background:rgba(245,166,35,0.12); color:var(--orange); border:1px solid rgba(245,166,35,0.25); }
.badge-modern { background:rgba(92,212,122,0.12); color:var(--green); border:1px solid rgba(92,212,122,0.25); }
.badge-deli { background:rgba(245,200,66,0.12); color:#e8c43a; border:1px solid rgba(245,200,66,0.25); }
.badge-market { background:rgba(245,200,66,0.12); color:#e8c43a; border:1px solid rgba(245,200,66,0.25); }

/* Filter bar */
.filter-bar {
  display:flex; gap:6px; padding:8px 20px; flex-wrap:wrap;
  border-bottom:1px solid var(--border);
}
.filter-chip {
  font-size:11px; font-weight:700; padding:5px 10px; border-radius:20px;
  cursor:pointer; transition:all 0.15s; border:1px solid var(--border);
  background:var(--card); color:var(--text2); font-family:var(--font);
  text-transform:uppercase; letter-spacing:0.04em;
}
.filter-chip:active { opacity:0.7; }
.filter-chip.on { background:var(--accent); color:#fff; border-color:var(--accent); }
.badge.clickable { cursor:pointer; }
.badge.clickable:active { opacity:0.7; }
.rest.dimmed { opacity:0.3; }
</style>
</head>
<body>
<div class="app">
  <div id="map"></div>
  <div class="panel" id="panel"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.85.1/dist/L.Control.Locate.min.js"></script>
<script>
// ============================================================
// ROME WALKING TOUR DATA
// ============================================================
const STOPS = [
  {
    n:1, name:"Trevi Fountain", lat:41.9009, lng:12.4833,
    time:"10:00", dur:"20 min", cost:"€2/pp",
    badge:"booked", badgeText:"BOOKED",
    notes:"Tickets pre-booked! Enter from Via delle Muratte side. Best photos from the right side looking at the fountain.",
    opt:false
  },
  {
    n:2, name:"Galleria Sciarra", lat:41.8990, lng:12.4842,
    time:"10:25", dur:"5 min", cost:"Free",
    notes:"Hidden Art Nouveau gem -- walk through the courtyard. Beautiful frescoes on the walls. Easy to miss the entrance.",
    opt:false
  },
  {
    n:3, name:"Spanish Steps", lat:41.9059, lng:12.4824,
    time:"10:40", dur:"15 min", cost:"Free",
    notes:"View from the bottom is best. Can't sit on the steps (it's illegal!). Keats-Shelley House is at the bottom right.",
    opt:false
  },
  {
    n:4, name:"Palazzo Barberini", lat:41.9035, lng:12.4897,
    time:"11:00", dur:"45 min", cost:"€12/pp",
    badge:"opt", badgeText:"OPTIONAL",
    notes:"National Gallery of Ancient Art. Raphael & Caravaggio. Skip if short on time -- nearest metro: Barberini.",
    opt:true
  },
  {
    n:5, name:"Piazza Navona", lat:41.8992, lng:12.4731,
    time:"11:15", dur:"20 min", cost:"Free",
    notes:"Three fountains, street artists. Flat & spacious -- great for stroller. Bernini's Fountain of the Four Rivers in the centre.",
    opt:false
  },
  {
    n:6, name:"Campo de' Fiori", lat:41.8956, lng:12.4722,
    time:"11:45", dur:"45 min", cost:"Free",
    badge:"lunch", badgeText:"LUNCH",
    notes:"Morning market (until ~14:00). Great lunch spots on side streets -- try Roscioli or Forno Campo de' Fiori for pizza al taglio.",
    opt:false
  },
  {
    n:7, name:"Galleria Doria Pamphilj", lat:41.8978, lng:12.4810,
    time:"12:45", dur:"45 min", cost:"€14/pp",
    badge:"opt", badgeText:"OPTIONAL",
    notes:"Stunning private palace gallery. Velazquez's Pope Innocent X is here. Audio guide included. Skip if tired.",
    opt:true
  },
  {
    n:8, name:"Piazza Venezia", lat:41.8958, lng:12.4823,
    time:"13:00", dur:"20 min", cost:"Free",
    badge:"end", badgeText:"FINISH",
    notes:"Vittoriano monument has free entry + paid roof terrace with panoramic views (€12). Great way to end the walk!",
    opt:false
  }
];

const RESTAURANTS = [
  // Centro Storico
  { name:"Ristorante Grano", lat:41.8999, lng:12.4757, area:"Centro Storico", addr:"Piazza Rondanini 53", tag:"roman", note:"Near Pantheon" },
  { name:"Roscioli", lat:41.8943, lng:12.4742, area:"Centro Storico", addr:"Via dei Giubbonari 21", tag:"deli", note:"Famous salumeria with kitchen. Book ahead." },
  { name:"Il SanLorenzo", lat:41.8953, lng:12.4742, area:"Centro Storico", addr:"Via dei Chiavari 4/5", tag:"seafood", note:"Upscale seafood. MICHELIN Guide listed." },
  { name:"Casa Bleve", lat:41.8976, lng:12.4751, area:"Centro Storico", addr:"Via del Teatro Valle 48", tag:"wine", note:"Wine bar & restaurant. Great wine list." },
  { name:"Osteria La Quercia", lat:41.8945, lng:12.4717, area:"Centro Storico", addr:"Piazza della Quercia 23", tag:"roman", note:"Near Campo de' Fiori" },
  { name:"Osteria delle Coppelle", lat:41.9009, lng:12.4760, area:"Centro Storico", addr:"Piazza delle Coppelle 54", tag:"roman", note:"Near Pantheon" },
  { name:"Retrobottega", lat:41.9019, lng:12.4752, area:"Centro Storico", addr:"Via della Stelletta 4", tag:"modern", note:"Modern Italian, open kitchen" },
  { name:"Hostaria da Pietro", lat:41.9084, lng:12.4782, area:"Centro Storico", addr:"Via Gesù e Maria 18", tag:"roman", note:"Near Piazza del Popolo / Via del Corso" },
  { name:"Per Me Giulio Terrinoni", lat:41.8973, lng:12.4674, area:"Centro Storico", addr:"Vicolo del Malpasso 9", tag:"michelin", note:"Michelin star. Book well ahead." },
  // Trastevere
  { name:"Da Teo", lat:41.8885, lng:12.4776, area:"Trastevere", addr:"Piazza dei Ponziani 7A", tag:"roman", note:"Classic Roman trattoria" },
  { name:"Zia Restaurant", lat:41.8870, lng:12.4681, area:"Trastevere", addr:"Via Goffredo Mameli 45", tag:"michelin", note:"Michelin star. Creative Italian." },
  // Testaccio / Ostiense
  { name:"Flavio al Velavevodetto", lat:41.8764, lng:12.4760, area:"Testaccio", addr:"Via di Monte Testaccio 97", tag:"roman", note:"Classic Roman. Built into Monte Testaccio." },
  { name:"Trattoria Pennestri", lat:41.8733, lng:12.4799, area:"Ostiense", addr:"Via Giovanni da Empoli 5", tag:"modern", note:"Modern Roman" },
  { name:"Trecca", lat:41.8535, lng:12.4868, area:"Ostiense", addr:"Via Alessandro Severo 222", tag:"market", note:"Market-style cuisine" },
  // Other
  { name:"Da Roberto e Loretta", lat:41.8790, lng:12.5058, area:"Esquilino", addr:"Via Saturnia 18-24", tag:"roman", note:"Traditional Roman trattoria" },
  { name:"Santo Palato", lat:41.8815, lng:12.5015, area:"San Giovanni", addr:"Via Gallia 28", tag:"roman", note:"Chef Sarah Cicolini. Offal & Roman classics." }
];

const AREA_ORDER = ["Centro Storico","Trastevere","Testaccio","Ostiense","Esquilino","San Giovanni"];

// ============================================================
// MAP SETUP
// ============================================================
const map = L.map('map', { zoomControl:false, tap:true });

// CartoDB Voyager tiles - clean and modern
L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
  attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
  subdomains:'abcd', maxZoom:19
}).addTo(map);

L.control.zoom({ position:'topright' }).addTo(map);
L.control.locate({
  position:'topright', flyTo:true,
  keepCurrentZoomLevel:false,
  icon:'fa fa-location-crosshairs',
  locateOptions:{ enableHighAccuracy:true }
}).addTo(map);

// ============================================================
// MARKERS + ROUTE (layer groups for tab switching)
// ============================================================
const markers = [];
const coords = [];
const routeLayer = L.layerGroup().addTo(map);
const restLayer = L.layerGroup();
const restMarkers = [];
let activeTab = 'route';
let activeFilter = null;

function popupHtml(s) {
  const gUrl = `https://www.google.com/maps/dir/?api=1&destination=${s.lat}%2C${s.lng}&travelmode=walking`;
  const aUrl = `https://maps.apple.com/?daddr=${s.lat},${s.lng}&dirflg=w`;
  return `<div class="pc">
    <div class="pc-top"><span class="pc-n">${s.n}</span><span class="pc-name">${s.name}</span></div>
    <div class="pc-meta">${s.time} &middot; ${s.dur}${s.cost!=='Free'?' &middot; '+s.cost:''}</div>
    <p class="pc-note">${s.notes}</p>
    <div class="pc-nav">
      <a class="apple" href="${aUrl}" target="_blank">Apple Maps</a>
      <a class="google" href="${gUrl}" target="_blank">Google Maps</a>
    </div>
  </div>`;
}

STOPS.forEach((s, i) => {
  const ll = [s.lat, s.lng];
  coords.push(ll);
  const icon = L.divIcon({
    className:'leaflet-div-icon',
    html:`<div class="mpin ${s.opt?'opt':'main'}" id="pin-${i}">${s.n}</div>`,
    iconSize:[36,36], iconAnchor:[18,18], popupAnchor:[0,-22]
  });
  const m = L.marker(ll, {icon}).bindPopup(popupHtml(s), {
    maxWidth:300, minWidth:220, className:'tp'
  }).addTo(routeLayer);
  markers.push(m);
});

L.polyline(coords, {
  color:'#f5a623', weight:4, opacity:0.8,
  dashArray:'8,6', lineJoin:'round', lineCap:'round'
}).addTo(routeLayer);

const routeBounds = L.latLngBounds(coords);
map.fitBounds(routeBounds, { padding:[40,40] });

// Tag badge helper
const TAG_LABELS = {
  michelin:'MICHELIN &#9733;', seafood:'SEAFOOD', wine:'WINE BAR',
  roman:'ROMAN', modern:'MODERN', deli:'DELI', market:'MARKET'
};
function tagBadge(tag) {
  if (!tag || !TAG_LABELS[tag]) return '';
  return `<span class="badge badge-${tag}">${TAG_LABELS[tag]}</span> `;
}

// Restaurant markers
function restPopupHtml(r) {
  const gUrl = `https://www.google.com/maps/dir/?api=1&destination=${r.lat}%2C${r.lng}&travelmode=walking`;
  const aUrl = `https://maps.apple.com/?daddr=${r.lat},${r.lng}&dirflg=w`;
  const badges = tagBadge(r.tag);
  return `<div class="pc">
    <div class="pc-top"><span class="pc-name">${r.name}</span></div>
    <div class="pc-meta">${badges}${r.area} &middot; ${r.addr}</div>
    ${r.note ? `<p class="pc-note">${r.note}</p>` : ''}
    <div class="pc-nav">
      <a class="apple" href="${aUrl}" target="_blank">Apple Maps</a>
      <a class="google" href="${gUrl}" target="_blank">Google Maps</a>
    </div>
  </div>`;
}

const restCoords = [];
RESTAURANTS.forEach((r, i) => {
  const ll = [r.lat, r.lng];
  restCoords.push(ll);
  const icon = L.divIcon({
    className:'leaflet-div-icon',
    html:`<div class="rpin${r.tag==='michelin'?' michelin':''}" id="rpin-${i}">${i+1}</div>`,
    iconSize:[28,28], iconAnchor:[14,14], popupAnchor:[0,-16]
  });
  const m = L.marker(ll, {icon}).bindPopup(restPopupHtml(r), {
    maxWidth:300, minWidth:220, className:'tp'
  }).addTo(restLayer);
  restMarkers.push(m);
});
const restBounds = L.latLngBounds(restCoords);

// ============================================================
// BOTTOM PANEL
// ============================================================
function renderPanel() {
  const p = document.getElementById('panel');
  let h = '';

  // Weather bar
  h += `<div class="wx">
    <span class="wx-icon">&#9925;</span>
    <span class="wx-temp">16&deg; / 5&deg;C</span>
    <div class="wx-detail">
      <span>Breaks of sun</span>
      <span>&middot; 5% rain</span>
      <span>&middot; Wind 7 km/h</span>
    </div>
  </div>`;

  // Tabs
  h += `<div class="tabs">
    <button class="tab${activeTab==='route'?' active':''}" onclick="switchTab('route')">Route</button>
    <button class="tab${activeTab==='restaurants'?' active':''}" onclick="switchTab('restaurants')">Restaurants</button>
  </div>`;

  if (activeTab === 'route') {
    h += renderRouteContent();
  } else {
    h += renderRestContent();
  }

  // Footer
  h += `<div class="footer">5 adults + 1 baby &middot; Feb 15–21 2026 &middot; Trevi tickets pre-booked<br>
  <span style="opacity:0.5;font-size:11px">Tap any stop to see it on the map. Navigate buttons open your maps app.</span></div>`;

  p.innerHTML = h;
}

function renderRouteContent() {
  let h = '';

  // Schedule header
  h += '<div class="shdr">Schedule &middot; 8 stops &middot; ~3 hrs</div>';

  // Stop cards
  STOPS.forEach((s, i) => {
    const gUrl = `https://www.google.com/maps/dir/?api=1&destination=${s.lat}%2C${s.lng}&travelmode=walking`;
    const aUrl = `https://maps.apple.com/?daddr=${s.lat},${s.lng}&dirflg=w`;
    const isLast = i === STOPS.length - 1;

    h += `<div class="stop${s.opt?' opt':''}" data-i="${i}" onclick="go(${i})">
      <div class="stop-left">
        <div class="snum ${s.opt?'opt':'main'}">${s.n}</div>
        ${!isLast ? '<div class="sline"></div>' : ''}
      </div>
      <div class="sinfo">
        <div class="sname">${s.name}</div>
        <div class="smeta">
          <span class="tm">${s.time}</span>
          <span>&middot;</span>
          <span>${s.dur}</span>
          ${s.cost!=='Free'?`<span>&middot;</span><span class="cost">${s.cost}</span>`:''}
          ${s.badge?`<span class="badge badge-${s.badge}">${s.badgeText}</span>`:''}
        </div>
        <div class="snote">${s.notes}</div>
        <div class="stop-expand">
          <div class="nav-row">
            <a class="nav-btn apple" href="${aUrl}" target="_blank" onclick="event.stopPropagation()">Apple Maps</a>
            <a class="nav-btn google" href="${gUrl}" target="_blank" onclick="event.stopPropagation()">Google Maps</a>
          </div>
        </div>
      </div>
    </div>`;
  });

  // Tips
  h += `<div class="tips">
    <div class="tip-card">
      <span class="tip-icon">&#127829;</span>
      <div><div class="tip-label" style="color:var(--orange)">Lunch</div>
      <div class="tip-text">Campo de' Fiori market area or Piazza Navona side streets. Try Roscioli for sit-down or Forno for quick pizza.</div></div>
    </div>
    <div class="tip-card">
      <span class="tip-icon">&#128118;</span>
      <div><div class="tip-label" style="color:var(--accent)">Baby-friendly</div>
      <div class="tip-text">Piazza Navona is flat & spacious for stroller breaks. Skip Barberini if baby is fussy.</div></div>
    </div>
    <div class="tip-card">
      <span class="tip-icon">&#128647;</span>
      <div><div class="tip-label" style="color:var(--blue)">Metro stations</div>
      <div class="tip-text">Barberini (near stop 4) or Spagna (near stop 3) -- both Line A. Useful if you need to bail early or rejoin.</div></div>
    </div>
    <div class="tip-card">
      <span class="tip-icon">&#128176;</span>
      <div><div class="tip-label" style="color:var(--green)">Budget (5 adults)</div>
      <div class="tip-text">Must-sees only: ~&#8364;35 total. All paid stops including optionals: ~&#8364;165 total. Baby free everywhere.</div></div>
    </div>
  </div>`;

  // Week overview
  h += `<div class="week">
    <div class="week-hdr">Trip Overview &middot; Feb 15&#8211;21</div>

    <div class="day day-today">
      <div class="day-date"><div class="day-dow">Sat</div><div class="day-num">15</div></div>
      <div class="day-info"><div class="day-events">
        <div class="day-event ev-booked">
          <span class="ev-time">10:00</span>
          <span class="ev-name">Walking Tour</span>
          <span class="ev-note">(this page!)</span>
          <span class="ev-badge">TODAY</span>
        </div>
        <div class="day-event ev-booked">
          <span class="ev-time">10:00</span>
          <span class="ev-name">Trevi Fountain</span>
          <span class="ev-badge">BOOKED</span>
        </div>
      </div></div>
    </div>

    <div class="day">
      <div class="day-date"><div class="day-dow">Sun</div><div class="day-num">16</div></div>
      <div class="day-info"><div class="day-open">Open &#8212; plan as you go</div></div>
    </div>

    <div class="day">
      <div class="day-date"><div class="day-dow">Mon</div><div class="day-num">17</div></div>
      <div class="day-info"><div class="day-open">Open &#8212; plan as you go</div></div>
    </div>

    <div class="day">
      <div class="day-date"><div class="day-dow">Tue</div><div class="day-num">18</div></div>
      <div class="day-info"><div class="day-open">Open &#8212; plan as you go</div></div>
    </div>

    <div class="day">
      <div class="day-date"><div class="day-dow">Wed</div><div class="day-num">19</div></div>
      <div class="day-info"><div class="day-events">
        <div class="day-event ev-booked">
          <span class="ev-time">10:00</span>
          <span class="ev-name">Pantheon</span>
          <span class="ev-note">&#8364;5/pp</span>
          <span class="ev-badge">BOOKED</span>
        </div>
      </div></div>
    </div>

    <div class="day">
      <div class="day-date"><div class="day-dow">Thu</div><div class="day-num">20</div></div>
      <div class="day-info"><div class="day-open">Open &#8212; plan as you go</div></div>
    </div>

    <div class="day">
      <div class="day-date"><div class="day-dow">Fri</div><div class="day-num">21</div></div>
      <div class="day-info"><div class="day-events">
        <div class="day-event">
          <span class="ev-time">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
          <span class="ev-name">Last day</span>
          <span class="ev-note">&#9992; Departure</span>
        </div>
      </div></div>
    </div>

  </div>`;

  return h;
}

function renderRestContent() {
  let h = '';

  const filtered = RESTAURANTS.filter(r => !activeFilter || r.tag === activeFilter);
  const countText = activeFilter ? filtered.length + '/' + RESTAURANTS.length : RESTAURANTS.length;
  h += '<div class="shdr">Restaurant Recommendations &middot; ' + countText + ' places</div>';

  // Filter chips
  const tags = [...new Set(RESTAURANTS.map(r => r.tag))];
  h += '<div class="filter-bar">';
  tags.forEach(t => {
    h += `<button class="filter-chip${activeFilter===t?' on':''}" onclick="filterTag('${t}')">${TAG_LABELS[t]}</button>`;
  });
  if (activeFilter) {
    h += `<button class="filter-chip" onclick="filterTag(null)" style="color:var(--accent)">&#10005; Clear</button>`;
  }
  h += '</div>';

  // Group by area
  let lastArea = '';
  RESTAURANTS.forEach((r, i) => {
    const show = !activeFilter || r.tag === activeFilter;
    if (show && r.area !== lastArea) {
      h += `<div class="rest-group-hdr">${r.area}</div>`;
      lastArea = r.area;
    }
    if (!show) return;
    const gUrl = `https://www.google.com/maps/dir/?api=1&destination=${r.lat}%2C${r.lng}&travelmode=walking`;
    const aUrl = `https://maps.apple.com/?daddr=${r.lat},${r.lng}&dirflg=w`;
    const badgeHtml = `<span class="badge badge-${r.tag} clickable" onclick="event.stopPropagation();filterTag('${r.tag}')">${TAG_LABELS[r.tag]}</span>`;

    h += `<div class="rest" data-ri="${i}" onclick="goRest(${i})">
      <div class="rnum${r.tag==='michelin'?' michelin':''}">${i+1}</div>
      <div class="rinfo">
        <div class="rname">${r.name} ${badgeHtml}</div>
        <div class="raddr">${r.addr}</div>
        ${r.note ? `<div class="rnote">${r.note}</div>` : ''}
        <div class="rlinks">
          <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(r.name+' '+r.addr+' Rome')}" target="_blank" onclick="event.stopPropagation()">Google Reviews</a>
          <a href="https://www.tripadvisor.com/Search?q=${encodeURIComponent(r.name+' Rome')}" target="_blank" onclick="event.stopPropagation()">TripAdvisor</a>
        </div>
        <div class="rest-expand">
          <div class="nav-row">
            <a class="nav-btn apple" href="${aUrl}" target="_blank" onclick="event.stopPropagation()">Apple Maps</a>
            <a class="nav-btn google" href="${gUrl}" target="_blank" onclick="event.stopPropagation()">Google Maps</a>
          </div>
        </div>
      </div>
    </div>`;
  });

  return h;
}

// ============================================================
// INTERACTION
// ============================================================
let activeStop = -1;

function switchTab(tab) {
  if (tab === activeTab) return;
  activeTab = tab;
  activeFilter = null;
  if (tab === 'route') {
    map.removeLayer(restLayer);
    routeLayer.addTo(map);
    map.fitBounds(routeBounds, { padding:[40,40] });
  } else {
    map.removeLayer(routeLayer);
    restLayer.addTo(map);
    map.fitBounds(restBounds, { padding:[40,40] });
  }
  map.closePopup();
  renderPanel();
}

function filterTag(tag) {
  activeFilter = (activeFilter === tag) ? null : tag;
  // Update map markers visibility
  RESTAURANTS.forEach((r, i) => {
    const show = !activeFilter || r.tag === activeFilter;
    if (show) { restMarkers[i].addTo(restLayer); }
    else { restLayer.removeLayer(restMarkers[i]); }
  });
  // Fit map to visible markers
  if (activeFilter) {
    const vis = RESTAURANTS.filter(r => r.tag === activeFilter).map(r => [r.lat, r.lng]);
    if (vis.length) map.fitBounds(L.latLngBounds(vis), { padding:[50,50] });
  } else {
    map.fitBounds(restBounds, { padding:[40,40] });
  }
  map.closePopup();
  renderPanel();
}

function go(i) {
  const s = STOPS[i];
  map.flyTo([s.lat, s.lng], 17, { duration:0.6 });
  markers[i].openPopup();

  document.querySelectorAll('.stop').forEach(c => {
    c.classList.remove('active','expanded');
  });
  const card = document.querySelector(`.stop[data-i="${i}"]`);
  if (card) {
    card.classList.add('active','expanded');
    setTimeout(() => card.scrollIntoView({ behavior:'smooth', block:'nearest' }), 100);
  }

  document.querySelectorAll('.mpin').forEach(p => p.classList.remove('active'));
  const pin = document.getElementById(`pin-${i}`);
  if (pin) pin.classList.add('active');
  activeStop = i;
}

function goRest(i) {
  const r = RESTAURANTS[i];
  map.flyTo([r.lat, r.lng], 17, { duration:0.6 });
  restMarkers[i].openPopup();

  document.querySelectorAll('.rest').forEach(c => {
    c.classList.remove('active','expanded');
  });
  const card = document.querySelector(`.rest[data-ri="${i}"]`);
  if (card) {
    card.classList.add('active','expanded');
    setTimeout(() => card.scrollIntoView({ behavior:'smooth', block:'nearest' }), 100);
  }

  document.querySelectorAll('.rpin').forEach(p => p.classList.remove('active'));
  const pin = document.getElementById(`rpin-${i}`);
  if (pin) pin.classList.add('active');
}

renderPanel();
</script>
</body>
</html>
